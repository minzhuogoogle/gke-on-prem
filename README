Summary
-------
The script gke_onprem_test is a sanity verification tool for GKE On-Prem
deployment for Google Cloud Platform Partner.

Prerequisite
------------
An existing GKE On-Prem deployment is DUT and is required before running the
script.

In addition to an existing GKE On-Prem deployment there are a few requirments
for wrokstation where script is going to run.
1. Workstation should have kubectl installed.
2. Workstation should have gkectl installed.
3. Workstation should have python installed.
4. Workstation should have ip access to server's ip for both admin and user
   cluster.
5. If desired testlog can be uploaded to Google Cloud Storage bucket.
   Scripe can load service account to have it authenticated for GCS bucket.
6. Script requires admin cluster kubecfg file and user cluster kubecfg file,
   which should be provided by partner.
7. Script requires VIP for workload load-balancer testing.


Where to get test script
------------------------
The scripts include:
    * test script gke_onprem_test.py

Script can be downloaded from:
1. Github: https://github.com/minzhuogoogle/gke-on-prem
2. GCS Bucket gs://anthos_ready_test_script/
   Google Cloud SDK is required to be installed to access GCS bucket.
3. Executable python binary: gke_onprem_test
   Note: this script can be run on admin workstation installed using OVA for
   Anthos Release 1.0.10.
4. All can be downloaded from gcs bucket:
gsutil ls gs://anthos_ready_test_script
gs://anthos_ready_test_script/README
gs://anthos_ready_test_script/gke_onprem_test
gs://anthos_ready_test_script/gke_onprem_test.py
gs://anthos_ready_test_script/myplatform.cfg.txt
gs://anthos_ready_test_script/sample.test.log


How to run it
------------------------
Before running the testing script copy admin and user cluster kubeconfig files
to the same directory.

When running script provide path to admin and user cluster config files, admin
cluster config file name, user cluster config file name and VIP for workload
load-balancer.

usage: gke_onprem_test.py [-h] -cfgpath CLUSTERCFGPATH -admin ADMCFG -user
                          USERCFG -lbip LBSVCIP [-testlog ANTHOSTESTLOG]
                          [-gcs GCSBUCKET] [-serviceacct SERVICEACCT]
                          [-loop TESTLOOP] [-abort] [-partner PARTNER]
                          [-platformcfg PLATFORMCFGFILE]

optional arguments:
  -h, --help            show this help message and exit
  -cfgpath CLUSTERCFGPATH, --clustercfgpath CLUSTERCFGPATH
                        Path for cluster kube config files
  -admin ADMCFG, --adminclustercfg ADMCFG
                        Admin Cluster kubeconfig file
  -user USERCFG, --userclustercfg USERCFG
                        User Cluster kubeconfig files
  -lbip LBSVCIP, --lbsvcip LBSVCIP
                        IP Address for Load-balancer for service to be
                        deployed
  -testlog ANTHOSTESTLOG, --anthostestlog ANTHOSTESTLOG
                        Prefix for test log file
  -gcs GCSBUCKET, --gcsbucket GCSBUCKET
                        GCS bucket where file is to be uploaded to
  -serviceacct SERVICEACCT, --serviceacct SERVICEACCT
                        service account used to authorize for GCS service
  -loop TESTLOOP, --testloop TESTLOOP
                        number of loops test cases to be run
  -abort, --abortonfailure
                        flag to set whether to abort test if failure occures
  -partner PARTNER, --partner PARTNER
                        Anthos Partner
  -platformcfg PLATFORMCFGFILE, --platformcfgfile PLATFORMCFGFILE
                        Partner provided file for platform detail information


Sample script run command:
-----------------------------
1. Run Test and abort test if test fails in the user cluster
./gke_onprem_test.py  -cfgpath /home/ubuntu/anthos_ready/kubecfg -admin kubeconfig.cpe.1
-user cpe-user-1-1-kubeconfig -lbip 100.115.253.112   --gcs gs://anthos_ready_test_log
-serviceacct /home/ubuntu/vsphere/release-reader-key.json
-platformcfg myplatform.cfg.txt -abort

2. Run Test and continue regardless whether test fails or not
./gke_onprem_test.py  -cfgpath /home/ubuntu/anthos_ready/kubecfg -admin kubeconfig.cpe.1
-user cpe-user-1-1-kubeconfig -lbip 100.115.253.112   --gcs gs://anthos_ready_test_log
-serviceacct /home/ubuntu/vsphere/release-reader-key.json
-platformcfg myplatform.cfg.txt

3. Run Test on multiple user clusters. User kube config files are divided by
comma
./gke_onprem_test.py  -cfgpath /home/ubuntu/anthos_ready/kubecfg -admin kubeconfig.cpe.1
-user cpe-user-1,cpe-user-2 -lbip 100.115.253.112   --gcs gs://anthos_ready_test_log
-serviceacct /home/ubuntu/vsphere/release-reader-key.json
-platformcfg myplatform.cfg.txt

4. Run test for loop 100
./gke_onprem_test.py  -cfgpath /home/ubuntu/anthos_ready/kubecfg -admin kubeconfig.cpe.1
-user cpe-user-1-1-kubeconfig -lbip 100.115.253.112   --gcs gs://anthos_ready_test_log
-serviceacct /home/ubuntu/vsphere/release-reader-key.json
-platformcfg myplatform.cfg.txt  -loop 100


Sample test output:
--------------------
 Summary:
     gkectl version: 1.0.6, gke_onprem_test version: 1.0.1
     partner: unknown, platform detail: myplatform.cfg.txt
       Vendor: MyExampe
       ESXi Version: ESXi 6.5 EP 14
       vCenter Version: vCenter Server 6.5 U2h
       Load Balancer: F5 VE BIGIP-13.1.1-0.0.4.ALL-scsi
       Server Model: SYS-6018R-TDW
       CPU Model: Intel Xeon Gold 6154
       CPU Number: 2
       Total pCore count: 36
       RAM: 384GB
       Disk Drives: 2x 480GB SSD SATA; 4x 3.84TB SSD SAS
       NIC model: Intel X520-DA2
       Shared Storage Solution: VMware VSAN

     admin cluster version: 1.11.2-gke.31, user cluster version: 1.11.2-gke.31
     Total Tests: 38, Passed Tests: 38, Failed Tests: 0
 ===============================================================================================================================================================================
       test_workload_deployment:PASS:Apply yaml file nginx.yaml in cluster cpe-user-1-1.
       test_workload_deployed:PASS:Verify workflow specified by nginx-sanity-ns is deployed in cluster cpe-user-1-1.
       test_workload_pod_state:PASS:Verify all pods for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 are Running.
       test_workload_number_of_pods:PASS:Verify number of pods for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 equals to the expected number 3.
       test_workload_service_state:PASS:Verify service for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 has LoadBalancer at 100.115.253.112.
       test_workload_accessible_via_lbsvcip:PASS:Verify service provided by workload is accessible via LBIP 100.115.253.112 in cluster cpe-user-1-1.
       test_service_traffic:PASS:Verify service traffic at 100.115.253.112 in user cluster cpe-user-1-1.
       test_workload_service_state:PASS:Verify deployment for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 equals to 3.
       test_workload_replica_state:PASS:Verify replicas for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 equals to 3.
       test_workload_deployed:PASS:Verify workflow specified by nginx-sanity-ns is deployed in cluster cpe-user-1-1.
       test_workload_pod_state:PASS:Verify all pods for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 are Running.
       test_workload_number_of_pods:PASS:Verify number of pods for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 equals to the expected number 6.
       test_workload_service_state:PASS:Verify service for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 has LoadBalancer at 100.115.253.112.
       test_workload_accessible_via_lbsvcip:PASS:Verify service provided by workload is accessible via LBIP 100.115.253.112 in cluster cpe-user-1-1.
       test_service_traffic:PASS:Verify service traffic at 100.115.253.112 in user cluster cpe-user-1-1.
       test_workload_service_state:PASS:Verify deployment for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 equals to 6.
       test_workload_replica_state:PASS:Verify replicas for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 equals to 6.
       test_workload_withdraw:PASS:Delete workflow defined by yaml file nginx.yaml in cluster cpe-user-1-1.
       test_workload_deleted:PASS:Workload defined by nginx.yaml is deleted for cluster /home/ubuntu/anthos_ready/kubecfg/cpe-user-1-1-kubeconfig in namespace nginx-sanity-ns.
       test_workload_deployment:PASS:Apply yaml file nginx.yaml in cluster cpe-user-1-1.
       test_workload_deployed:PASS:Verify workflow specified by nginx-sanity-ns is deployed in cluster cpe-user-1-1.
       test_workload_pod_state:PASS:Verify all pods for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 are Running.
       test_workload_number_of_pods:PASS:Verify number of pods for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 equals to the expected number 3.
       test_workload_service_state:PASS:Verify service for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 has LoadBalancer at 100.115.253.112.
       test_workload_accessible_via_lbsvcip:PASS:Verify service provided by workload is accessible via LBIP 100.115.253.112 in cluster cpe-user-1-1.
       test_service_traffic:PASS:Verify service traffic at 100.115.253.112 in user cluster cpe-user-1-1.
       test_workload_service_state:PASS:Verify deployment for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 equals to 3.
       test_workload_replica_state:PASS:Verify replicas for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 equals to 3.
       test_workload_deployed:PASS:Verify workflow specified by nginx-sanity-ns is deployed in cluster cpe-user-1-1.
       test_workload_pod_state:PASS:Verify all pods for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 are Running.
       test_workload_number_of_pods:PASS:Verify number of pods for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 equals to the expected number 6.
       test_workload_service_state:PASS:Verify service for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 has LoadBalancer at 100.115.253.112.
       test_workload_accessible_via_lbsvcip:PASS:Verify service provided by workload is accessible via LBIP 100.115.253.112 in cluster cpe-user-1-1.
       test_service_traffic:PASS:Verify service traffic at 100.115.253.112 in user cluster cpe-user-1-1.
       test_workload_service_state:PASS:Verify deployment for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 equals to 6.
       test_workload_replica_state:PASS:Verify replicas for workload specified by nginx-sanity-ns deployed in cluster cpe-user-1-1 equals to 6.
       test_workload_withdraw:PASS:Delete workflow defined by yaml file nginx.yaml in cluster cpe-user-1-1.
       test_workload_deleted:PASS:Workload defined by nginx.yaml is deleted for cluster /home/ubuntu/anthos_ready/kubecfg/userclustercfg in namespace nginx-sanity-ns.
 ===============================================================================================================================================================================

Version History
-----------------
V1.0.1  June 2019

FAQ
-----


Contact
-------
anthos-platform-ready@google.com
